language: node_js

branches:
  only:
    - '3.0.0'

jobs:
  include:
    - stage: test
      env: CI_BUILD_TYPE=node
      node_js: 10
      before_install:
        - yarn config set registry https://registry.npmjs.org/
        - yarn add @chialab/rna-cli codecov -D
      install:
        - yarn
      script:
        - yarn test:node
      after_success:
        - cat test/__coverage__/*/lcov.info | ./node_modules/.bin/codecov
    - stage: test
      os: linux
      env: CI_BUILD_TYPE=saucelabs
      node_js: 10
      before_install:
        - yarn config set registry https://registry.npmjs.org/
        - yarn add @chialab/rna-cli codecov -D
      install:
        - yarn
      script:
        - yarn test:saucelabs
      after_success:
        - cat test/__coverage__/*/lcov.info | ./node_modules/.bin/codecov
    - stage: 'docs'
      env: CI_BUILD_TYPE=docs
      os: linux
      node_js: 10
      install:
        - yarn config set registry https://registry.npmjs.org/
        - yarn add @chialab/rna-cli -D
      script:
        - yarn
        - git config --global user.email "travis@travis-ci.org"
        - git config --global user.name "travis-ci"
        - git clone https://${GH_TOKEN}@github.com/chialab/dna.wiki.git wiki
        - git -C wiki checkout -B $TRAVIS_BRANCH
        - rna documentate --output wiki/API.md --header '# API References'"
        - git -C wiki add .
        - git -C wiki diff-index --quiet HEAD || git -C wiki commit -m "Lastest api reference on successful travis build ${TRAVIS_BUILD_NUMBER} auto-pushed to wiki"
        - git -C wiki push origin
  allow_failures:
    - env: CI_BUILD_TYPE=docs
